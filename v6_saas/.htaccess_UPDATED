# ================================================================
# SERPIFAI API ACCESS - BYPASS WORDPRESS/COMING SOON
# CRITICAL: This MUST be BEFORE WordPress rules
# ================================================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    
    # ============================================================
    # PRIORITY 1: Allow serpifai_php API folder (bypass all redirects)
    # ============================================================
    
    # Don't redirect API folder to WordPress
    RewriteCond %{REQUEST_URI} ^/serpifai_php/ [NC]
    RewriteRule ^ - [L]
    
    # Don't redirect API PHP files
    RewriteCond %{REQUEST_URI} ^/serpifai_php/.*\.php$ [NC]
    RewriteRule ^ - [L]
</IfModule>

# ============================================================
# ALLOW DIRECT ACCESS TO API FILES
# ============================================================

<FilesMatch "^(api_gateway|database|config|user_handler|gemini_handler|serper_handler)\.php$">
    <IfModule mod_authz_core.c>
        Require all granted
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Allow from all
    </IfModule>
</FilesMatch>

# ============================================================
# PROTECT serpifai_php DIRECTORY
# ============================================================

<Directory "/public_html/serpifai_php">
    Options -Indexes +FollowSymLinks
    <IfModule mod_authz_core.c>
        Require all granted
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Allow from all
    </IfModule>
</Directory>

# ============================================================
# ENSURE PHP FILES EXECUTE (Don't Download)
# ============================================================

<IfModule mod_mime.c>
    AddHandler application/x-httpd-php .php
</IfModule>

# ================================================================
# WORDPRESS & PERFORMANCE OPTIMIZATION
# ================================================================

# BEGIN WordPress
<IfModule mod_expires.c>
	ExpiresActive On
	ExpiresByType image/jpg "access plus 1 year"
	ExpiresByType image/jpeg "access plus 1 year"
	ExpiresByType image/gif "access plus 1 year"
	ExpiresByType image/png "access plus 1 year"
	ExpiresByType text/css "access plus 1 month"
	ExpiresByType application/pdf "access plus 1 month"
	ExpiresByType text/javascript "access plus 1 month"
	ExpiresByType image/x-icon "access plus 1 year"
	ExpiresDefault "access plus 1 weeks"
</IfModule>

<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    
    # Skip WordPress rules for API folder (redundant safety check)
    RewriteCond %{REQUEST_URI} !^/serpifai_php/ [NC]
    
    # Standard WordPress rules
    RewriteRule ^index\.php$ - [L]
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule . /index.php [L]
</IfModule>

# END WordPress

# ================================================================
# SECURITY HEADERS (Optional but recommended)
# ================================================================

<IfModule mod_headers.c>
    # Allow CORS for API (adjust origins as needed)
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "POST, GET, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
    
    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
</IfModule>
